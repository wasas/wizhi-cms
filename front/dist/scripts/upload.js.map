{"version":3,"sources":["../assets/scripts/forms/dmuploader.js"],"names":["$","defaults","url","document","URL","method","extraData","maxFileSize","allowedTypes","dataType","fileName","onInit","onFallbackMode","message","onNewFile","id","file","onBeforeUpload","onComplete","onUploadProgress","percent","onUploadSuccess","data","onUploadError","onFileTypeError","onFileSizeError","DmUploader","element","options","this","settings","extend","checkBrowser","init","prototype","undefined","window","FormData","call","find","length","checkEvent","eventName","createElement","isSupported","setAttribute","removeAttribute","widget","queue","Array","queuePos","queueRunning","on","evt","preventDefault","files","originalEvent","dataTransfer","queueFiles","target","val","j","i","size","type","match","push","index","processQueue","fd","append","each","exKey","exVal","ajax","cache","contentType","processData","forceSync","xhr","xhrobj","ajaxSettings","upload","addEventListener","event","position","loaded","total","e","totalSize","lengthComputable","Math","ceil","success","error","status","errMsg","complete","textStatus","fn","dmUploader","stopPropagation","jQuery","ready","show","thumb","value","parent","remove"],"mappings":"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","file":"upload.js","sourcesContent":["/*\n * dmuploader.js - Jquery File Uploader - 0.1\n * http://www.daniel.com.uy/projects/jquery-file-uploader/\n *\n * Copyright (c) 2013 Daniel Morales\n * Dual licensed under the MIT and GPL licenses.\n * http://www.daniel.com.uy/doc/license/\n */\n\n(function ($) {\n    var pluginName = 'dmUploader';\n\n    // These are the plugin defaults values\n    var defaults = {\n        url             : document.URL,\n        method          : 'POST',\n        extraData       : {},\n        maxFileSize     : 0,\n        allowedTypes    : '*',\n        dataType        : null,\n        fileName        : 'file',\n        onInit          : function () {\n        },\n        onFallbackMode  : function () {\n            message\n        },\n        onNewFile       : function (id, file) {\n        },\n        onBeforeUpload  : function (id) {\n        },\n        onComplete      : function () {\n        },\n        onUploadProgress: function (id, percent) {\n        },\n        onUploadSuccess : function (id, data) {\n        },\n        onUploadError   : function (id, message) {\n        },\n        onFileTypeError : function (file) {\n        },\n        onFileSizeError : function (file) {\n        }\n    };\n\n    var DmUploader = function (element, options) {\n        this.element = $(element);\n\n        this.settings = $.extend({}, defaults, options);\n\n        if (!this.checkBrowser()) {\n            return false;\n        }\n\n        this.init();\n\n        return true;\n    };\n\n    /**\n     * 检查浏览器\n     */\n    DmUploader.prototype.checkBrowser = function () {\n        if (window.FormData === undefined) {\n            this.settings.onFallbackMode.call(this.element, 'Browser doesn\\'t support From API');\n\n            return false;\n        }\n\n        if (this.element.find('input[type=file]').length > 0) {\n            return true;\n        }\n\n        if (!this.checkEvent('drop', this.element) || !this.checkEvent('dragstart', this.element)) {\n            this.settings.onFallbackMode.call(this.element, 'Browser doesn\\'t support Ajax Drag and Drop');\n\n            return false;\n        }\n\n        return true;\n    };\n\n\n    /**\n     * 插件事件\n     */\n    DmUploader.prototype.checkEvent = function (eventName, element) {\n        var element = element || document.createElement('div');\n        var eventName = 'on' + eventName;\n\n        var isSupported = eventName in element;\n\n        if (!isSupported) {\n            if (!element.setAttribute) {\n                element = document.createElement('div');\n            }\n            if (element.setAttribute && element.removeAttribute) {\n                element.setAttribute(eventName, '');\n                isSupported = typeof element[eventName] == 'function';\n\n                if (typeof element[eventName] != 'undefined') {\n                    element[eventName] = undefined;\n                }\n                element.removeAttribute(eventName);\n            }\n        }\n\n        element = null;\n        return isSupported;\n    };\n\n\n    /**\n     * 初始化\n     */\n    DmUploader.prototype.init = function () {\n        var widget = this;\n\n        widget.queue = new Array();\n        widget.queuePos = -1;\n        widget.queueRunning = false;\n\n        // -- Drag and drop event\n        widget.element.on('drop', function (evt) {\n            evt.preventDefault();\n            var files = evt.originalEvent.dataTransfer.files;\n\n            widget.queueFiles(files);\n        });\n\n        //-- Optional File input to make a clickable area\n        widget.element.find('input[type=file]').on('change', function (evt) {\n            var files = evt.target.files;\n\n            widget.queueFiles(files);\n\n            $(this).val('');\n        });\n\n        this.settings.onInit.call(this.element);\n    };\n\n\n    /**\n     * 排队文件\n     */\n    DmUploader.prototype.queueFiles = function (files) {\n        var j = this.queue.length;\n\n        for (var i = 0; i < files.length; i++) {\n            var file = files[i];\n\n            // Check file size\n            if ((this.settings.maxFileSize > 0) &&\n                (file.size > this.settings.maxFileSize)) {\n\n                this.settings.onFileSizeError.call(this.element, file);\n\n                continue;\n            }\n\n            // Check file type\n            if ((this.settings.allowedTypes != '*') &&\n                !file.type.match(this.settings.allowedTypes)) {\n\n                this.settings.onFileTypeError.call(this.element, file);\n\n                continue;\n            }\n\n            this.queue.push(file);\n\n            var index = this.queue.length - 1;\n\n            this.settings.onNewFile.call(this.element, index, file);\n        }\n\n        // Only start Queue if we haven't!\n        if (this.queueRunning) {\n            return false;\n        }\n\n        // and only if new Failes were succefully added\n        if (this.queue.length == j) {\n            return false;\n        }\n\n        this.processQueue();\n\n        return true;\n    };\n\n\n    /**\n     * 处理队列\n     */\n    DmUploader.prototype.processQueue = function () {\n        var widget = this;\n\n        widget.queuePos++;\n\n        if (widget.queuePos >= widget.queue.length) {\n            // Cleanup\n\n            widget.settings.onComplete.call(widget.element);\n\n            // Wait until new files are droped\n            widget.queuePos = (widget.queue.length - 1);\n\n            widget.queueRunning = false;\n\n            return;\n        }\n\n        var file = widget.queue[widget.queuePos];\n\n        // Form Data\n        var fd = new FormData();\n        fd.append(widget.settings.fileName, file);\n\n        // Append extra Form Data\n        $.each(widget.settings.extraData, function (exKey, exVal) {\n            fd.append(exKey, exVal);\n        });\n\n        widget.settings.onBeforeUpload.call(widget.element, widget.queuePos);\n\n        widget.queueRunning = true;\n\n        // Ajax 提交\n        $.ajax({\n            url        : widget.settings.url,\n            type       : widget.settings.method,\n            dataType   : widget.settings.dataType,\n            data       : fd,\n            cache      : false,\n            contentType: false,\n            processData: false,\n            forceSync  : false,\n            xhr        : function () {\n                var xhrobj = $.ajaxSettings.xhr();\n                if (xhrobj.upload) {\n                    xhrobj.upload.addEventListener('progress', function (event) {\n                        var percent = 0;\n                        var position = event.loaded || event.position;\n                        var total = event.total || e.totalSize;\n                        if (event.lengthComputable) {\n                            percent = Math.ceil(position / total * 100);\n                        }\n\n                        widget.settings.onUploadProgress.call(widget.element, widget.queuePos, percent);\n                    }, false);\n                }\n\n                return xhrobj;\n            },\n            success    : function (data, message, xhr) {\n                widget.settings.onUploadSuccess.call(widget.element, widget.queuePos, data);\n            },\n            error      : function (xhr, status, errMsg) {\n                widget.settings.onUploadError.call(widget.element, widget.queuePos, errMsg);\n            },\n            complete   : function (xhr, textStatus) {\n                widget.processQueue();\n            }\n        });\n    };\n\n\n    /**\n     * 功能函数\n     */\n    $.fn.dmUploader = function (options) {\n        return this.each(function () {\n            if (!$.data(this, pluginName)) {\n                $.data(this, pluginName, new DmUploader(this, options));\n            }\n        });\n    };\n\n    // -- Disable Document D&D events to prevent opening the file on browser when we drop them\n    $(document).on('dragenter', function (e) {\n        e.stopPropagation();\n        e.preventDefault();\n    });\n\n    $(document).on('dragover', function (e) {\n        e.stopPropagation();\n        e.preventDefault();\n    });\n\n    $(document).on('drop', function (e) {\n        e.stopPropagation();\n        e.preventDefault();\n    });\n})(jQuery);\n\n\njQuery(document).ready(function($){\n    $('.fn-dnd-zone').dmUploader({\n        url            : $('.fn-dnd-zone .upload_shadow').data('url'),\n        type           : 'POST',\n        dataType       : 'json',\n        allowedTypes   : 'image/*',\n        onUploadSuccess: function (id, data) {\n            $(this).find('.frm-thumbs').append('<input type=\"hidden\" name=\"' + $(this).data('name') + '\" value=\"' + data.id + '\">');\n\n            $(this).find('.frm-preview').show()\n                   .append('<div class=\"col-xs-6 col-md-3\"><button data-value=\"' + data.id + '\" type=\"button\" class=\"close\"><span>×</span></button><a href=\"#\" class=\"thumbnail\"><img src=\"' + data.thumb + '\" alt=\"...\"></a></div>');\n        }\n    });\n\n    // 删除已添加的缩略图，需要保存后才能生效\n    $('.fn-dnd-zone button.close').on('click', function () {\n        var value = $(this).data('value');\n\n        $(this).parent().remove();\n        $('.frm-thumbs input[value=' + value + ']').remove();\n    });\n});"],"sourceRoot":"assets/scripts/"}